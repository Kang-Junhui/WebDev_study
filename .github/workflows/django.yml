name: Django Board CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, closed]

jobs:
  test:
    runs-on: ubuntu-latest
    # PRì´ ë‹«í˜”ì„ ë•ŒëŠ” í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸° (ë³‘í•©ì‹œì—ëŠ” ë³„ë„ ì²˜ë¦¬)
    if: github.event.action != 'closed'
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: board_db_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run migrations
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/board_db_test
      run: |
        python manage.py migrate
        
    - name: Run tests
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/board_db_test
      run: |
        python manage.py test
        
    - name: Check code style with flake8
      run: |
        pip install flake8
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  # PR ì •ë³´ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
  pr-info:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - name: PR ì •ë³´ ì¶œë ¥
      run: |
        echo "ğŸ”„ Pull Request ì´ë²¤íŠ¸ ê°ì§€"
        echo "PR ë²ˆí˜¸: ${{ github.event.number }}"
        echo "PR ì œëª©: ${{ github.event.pull_request.title }}"
        echo "ì‘ì„±ì: ${{ github.event.pull_request.user.login }}"
        echo "ì•¡ì…˜: ${{ github.event.action }}"
        echo "ë³‘í•©ë¨: ${{ github.event.pull_request.merged }}"
        echo "ë² ì´ìŠ¤ ë¸Œëœì¹˜: ${{ github.event.pull_request.base.ref }}"
        echo "ì†ŒìŠ¤ ë¸Œëœì¹˜: ${{ github.event.pull_request.head.ref }}"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    # main ë¸Œëœì¹˜ ì§ì ‘ í‘¸ì‹œ ë˜ëŠ” mainìœ¼ë¡œ ë³‘í•©ëœ PRì¸ ê²½ìš°ì—ë§Œ ë°°í¬
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true))
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ë°°í¬ ì•Œë¦¼
      run: |
        if [ "${{ github.event_name }}" = "push" ]; then
          echo "ğŸš€ Direct Push ë°°í¬"
          echo "í‘¸ì‹œí•œ ì‚¬ìš©ì: ${{ github.event.pusher.name }}"
          echo "ì»¤ë°‹ ìˆ˜: ${{ github.event.commits.length }}"
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "ğŸ”€ Pull Request ë³‘í•© ë°°í¬"
          echo "PR ë²ˆí˜¸: #${{ github.event.number }}"
          echo "PR ì œëª©: ${{ github.event.pull_request.title }}"
          echo "ì‘ì„±ì: ${{ github.event.pull_request.user.login }}"
          echo "ë³‘í•©í•œ ì‚¬ìš©ì: ${{ github.event.pull_request.merged_by.login }}"
        fi
        echo "âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼"
        echo "ğŸ“¦ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ"
        echo "ğŸ”§ í”„ë¡œë•ì…˜ ì„œë²„ì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í•˜ì„¸ìš”"